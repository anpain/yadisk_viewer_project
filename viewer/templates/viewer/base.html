<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Просмотр Яндекс.Диска{% endblock %}</title>
    {% load static %}
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: auto; }
        .error { color: red; border: 1px solid red; padding: 10px; margin-bottom: 15px; }
        .file-list { list-style: none; padding: 0; margin-top: 15px; }
        .file-list li { display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; gap: 10px;}
        .file-list li:last-child { border-bottom: none; }
        .file-icon { width: 20px; height: 20px; flex-shrink: 0; }
        .file-preview { max-height: 40px; max-width: 60px; margin-right: 10px; vertical-align: middle; cursor: pointer; flex-shrink: 0; border: 1px solid #ddd; }
        .file-name { flex-grow: 1; margin-right: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .file-name a { color: #007bff; text-decoration: none; font-weight: bold; }
        .file-name a:hover { text-decoration: underline; }
        .file-name span { font-weight: normal; }
        .file-size { color: #666; min-width: 80px; text-align: right; margin-right: 15px; flex-shrink: 0; font-size: 0.9em;}
        .file-actions a { margin-left: 5px; padding: 3px 8px; cursor: pointer; text-decoration: none; font-size: 0.9em; border: 1px solid #ccc; border-radius: 3px; background-color: #f0f0f0; color: #333;}
        .file-actions a:hover { background-color: #e0e0e0;}
        .filter-buttons { margin-top: 15px; margin-bottom: 10px; }
        .filter-buttons a { margin-right: 10px; text-decoration: none; padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; color: #007bff; }
        .filter-buttons a.active { background-color: #eee; font-weight: bold; color: #333;}
        .filter-buttons span { margin-right: 5px; color: #666; }
        .zip-download-form { margin-top: 10px;}
        .zip-download-form button { margin-top: 10px; padding: 8px 15px; }
        input[type="text"] { width: 70%; padding: 8px; margin-right: 5px; border: 1px solid #ccc; }
        button[type="submit"] { padding: 8px 15px; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .select-all-container { margin-bottom: 5px; font-size: 0.9em; padding-left: 2px; }
        .select-all-container label { margin-left: 5px; cursor: pointer; }
        .no-files-message { margin-top: 15px; color: #666; padding: 10px; background-color: #f9f9f9; border: 1px dashed #ddd;}
        .breadcrumbs { font-size: 0.9em; margin-bottom: 15px; color: #555;}
        .breadcrumbs a { color: #007bff; text-decoration: none; }
        .breadcrumbs a:hover { text-decoration: underline; }
        .breadcrumbs strong { font-weight: bold; color: #333; }

        .pagination { margin-top: 20px; margin-bottom: 10px; text-align: center; font-size: 0.9em;}
        .pagination a, .pagination span { margin: 0 3px; padding: 5px 10px; border: 1px solid #ccc; text-decoration: none; color: #007bff; border-radius: 3px;}
        .pagination span.current { font-weight: bold; background-color: #eee; color: #333; border-color: #ccc;}
        .pagination span.disabled { color: #999; border-color: #ddd; background-color: #f9f9f9; cursor: default;}
        .page-size-controls { margin-bottom: 15px; text-align: right; font-size: 0.9em; color: #666; }
        .page-size-controls a { margin-left: 5px; color: #007bff; text-decoration: none;}
        .page-size-controls a:hover { text-decoration: underline; }
        .page-size-controls strong { font-weight: bold; color: #333;}

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            width: auto;
            height: auto;
            max-width: 90%;
            max-height: 85vh;
            animation-name: zoom;
            animation-duration: 0.4s;
        }
        @keyframes zoom { from {transform:scale(0.1)} to {transform:scale(1)} }
        #modalCaption {
            margin: 15px auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: #ccc;
            font-size: 0.9em;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus { color: #bbb; text-decoration: none; cursor: pointer; }
         @media (max-width: 700px){ .modal-close { top: 10px; right: 20px; font-size: 30px;} }

    </style>
</head>
<body>
    <h1>Просмотр публичных ссылок Яндекс.Диска</h1>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <div id="imagePreviewModal" class="modal">
        <span class="modal-close" title="Закрыть">×</span>
        <img class="modal-content" id="modalImage" alt="Превью изображения">
        <div id="modalCaption"></div>
    </div>

    {% block scripts %}
    <script>
        const modal = document.getElementById("imagePreviewModal");
        const modalImg = document.getElementById("modalImage");
        const captionText = document.getElementById("modalCaption");
        const closeModalSpan = document.querySelector(".modal-close");

        function openImageModal(imgElement) {
            if (!modal || !modalImg || !captionText) return;
            const fullImageUrl = imgElement.dataset.fullsize;
            const altText = imgElement.alt || "Превью изображения";
            if (fullImageUrl) {
                modal.style.display = "block";
                modalImg.src = fullImageUrl;
                captionText.innerHTML = altText;
            }
        }
        function closeModal() {
             if (!modal) return;
            modal.style.display = "none";
            modalImg.src = "";
        }

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('file-preview')) {
                event.preventDefault();
                openImageModal(event.target);
            }
            if (event.target.matches('.pagination a, .filter-buttons a, .breadcrumbs a, .page-size-controls a')) {
                 event.preventDefault();
                 const url = event.target.href;
                 if(url) window.location.href = url;
            }
        });

        if (closeModalSpan) { closeModalSpan.onclick = closeModal; }
        window.onclick = function(event) { if (event.target == modal) { closeModal(); } }
        document.addEventListener('keydown', function(event) { if (event.key === "Escape" && modal && modal.style.display === "block") { closeModal(); } });

         const selectAllCheckbox = document.getElementById('select-all');
         const fileCheckboxes = document.querySelectorAll('.file-list input[name="selected_files"]');
         const zipButton = document.querySelector('.zip-download-form button[type="submit"]');

         function toggleZipButton() {
             if (!zipButton) return;
             const anyChecked = Array.from(fileCheckboxes).some(cb => cb.checked);
             zipButton.disabled = !anyChecked;
         }

         if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                fileCheckboxes.forEach(checkbox => { checkbox.checked = selectAllCheckbox.checked; });
                toggleZipButton();
            });
         }

         fileCheckboxes.forEach(checkbox => {
             checkbox.addEventListener('change', function() {
                 if (!checkbox.checked && selectAllCheckbox) {
                     selectAllCheckbox.checked = false;
                 } else if (selectAllCheckbox && Array.from(fileCheckboxes).every(cb => cb.checked)) {
                      selectAllCheckbox.checked = true;
                 }
                 toggleZipButton();
             });
         });

         if(zipButton) {
             toggleZipButton();
         }

         const urlForm = document.querySelector('form[method="post"]');
         const submitButton = urlForm ? urlForm.querySelector('button[type="submit"]') : null;
         if(urlForm && submitButton) {
             urlForm.addEventListener('submit', function() {
                 submitButton.disabled = true;
                 submitButton.textContent = 'Загрузка...';
             });
         }
    </script>
    {% endblock %}
</body>
</html>