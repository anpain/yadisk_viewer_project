<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Просмотр Яндекс.Диска{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'viewer/style.css' %}">
</head>
<body>
    <h1>Просмотр публичных ссылок Яндекс.Диска</h1>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <div id="imagePreviewModal" class="modal">
        <span class="modal-close" title="Закрыть">×</span>
        <img class="modal-content" id="modalImage" alt="Превью изображения">
        <div id="modalCaption"></div>
    </div>

    {% block scripts %}
    <script>
        const modal = document.getElementById("imagePreviewModal");
        const modalImg = document.getElementById("modalImage");
        const captionText = document.getElementById("modalCaption");
        const closeModalSpan = document.querySelector(".modal-close");

        function openImageModal(imgElement) {
            if (!modal || !modalImg || !captionText) return;
            const fullImageUrl = imgElement.dataset.fullsize;
            const altText = imgElement.alt || "Превью изображения";
            if (fullImageUrl) {
                modal.style.display = "block";
                modalImg.src = fullImageUrl;
                captionText.innerHTML = altText;
            }
        }
        function closeModal() {
             if (!modal) return;
            modal.style.display = "none";
            modalImg.src = "";
        }

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('file-preview')) {
                event.preventDefault();
                openImageModal(event.target);
            }
            if (event.target.matches('.pagination a, .filter-buttons a, .breadcrumbs a, .page-size-controls a')) {
                 event.preventDefault();
                 const url = event.target.href;
                 if(url) window.location.href = url;
            }
        });

        if (closeModalSpan) { closeModalSpan.onclick = closeModal; }
        window.onclick = function(event) { if (event.target == modal) { closeModal(); } }
        document.addEventListener('keydown', function(event) { if (event.key === "Escape" && modal && modal.style.display === "block") { closeModal(); } });

         const selectAllCheckbox = document.getElementById('select-all');
         const fileCheckboxes = document.querySelectorAll('.file-list input[name="selected_files"]');
         const zipButton = document.querySelector('.zip-download-form button[type="submit"]');

         function toggleZipButton() {
             if (!zipButton) return;
             const anyChecked = Array.from(fileCheckboxes).some(cb => cb.checked);
             zipButton.disabled = !anyChecked;
         }

         if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                fileCheckboxes.forEach(checkbox => { checkbox.checked = selectAllCheckbox.checked; });
                toggleZipButton();
            });
         }

         fileCheckboxes.forEach(checkbox => {
             checkbox.addEventListener('change', function() {
                 if (!checkbox.checked && selectAllCheckbox) {
                     selectAllCheckbox.checked = false;
                 } else if (selectAllCheckbox && Array.from(fileCheckboxes).every(cb => cb.checked)) {
                      selectAllCheckbox.checked = true;
                 }
                 toggleZipButton();
             });
         });

         if(zipButton) {
             toggleZipButton();
         }

         const urlForm = document.querySelector('form[method="post"]');
         const submitButton = urlForm ? urlForm.querySelector('button[type="submit"]') : null;
         if(urlForm && submitButton) {
             urlForm.addEventListener('submit', function() {
                 submitButton.disabled = true;
                 submitButton.textContent = 'Загрузка...';
             });
         }
    </script>
    {% endblock %}
</body>
</html>