{% extends "viewer/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Просмотр ссылки Яндекс.Диска{% endblock %}

{% block content %}
    <form method="post" class="url-form">
        {% csrf_token %}
        <input type="text" name="public_url" placeholder="Вставьте публичную ссылку Яндекс.Диска..." value="{{ public_url|default:'' }}" required aria-label="Ссылка Яндекс.Диска">
        <button type="submit" class="btn">Обзор</button>
    </form>

    {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
    {% endif %}

    {% if data %}
        <h2 class="content-header">{{ data.name }}</h2>

        {% if available_file_types or data.type == 'dir' and items is not None %}
            <div class="filter-controls">
                <span>Фильтр:</span>
                <a href="#" data-filter="all" class="btn btn-sm {% if filter_type == 'all' %}active{% endif %}">Все</a>
                {% if 'image' in available_file_types %}<a href="#" data-filter="image" class="btn btn-sm {% if filter_type == 'image' %}active{% endif %}">Изображения</a>{% endif %}
                {% if 'document' in available_file_types %}<a href="#" data-filter="document" class="btn btn-sm {% if filter_type == 'document' %}active{% endif %}">Документы</a>{% endif %}
                {% if 'archive' in available_file_types %}<a href="#" data-filter="archive" class="btn btn-sm {% if filter_type == 'archive' %}active{% endif %}">Архивы</a>{% endif %}
                {% if 'video' in available_file_types %}<a href="#" data-filter="video" class="btn btn-sm {% if filter_type == 'video' %}active{% endif %}">Видео</a>{% endif %}
                {% if 'audio' in available_file_types %}<a href="#" data-filter="audio" class="btn btn-sm {% if filter_type == 'audio' %}active{% endif %}">Аудио</a>{% endif %}
                {% if 'other' in available_file_types %}<a href="#" data-filter="other" class="btn btn-sm {% if filter_type == 'other' %}active{% endif %}">Прочее</a>{% endif %}
            </div>
        {% endif %}

        {% if data.type == 'dir' %}
        <form id="zip-form" action="{% url 'viewer:download_zip' %}" method="post" class="zip-download-form">
            {% csrf_token %}
            <ul class="file-list">
                {% if items %}
                <li class="select-all-container">
                     <input type="checkbox" id="select-all" title="Выбрать все/Снять выделение">
                     <label for="select-all" style="cursor: pointer; margin: 0; font-weight: 500;">Выбрать все для ZIP</label>
                </li>
                {% endif %}

                {% for item in items %}
                    <li class="file-item">
                        {% if item.type == 'dir' %}
                             <img src="{% static 'viewer/folder.png' %}" alt="Папка" class="file-icon">
                             <span class="file-name"><strong>{{ item.name }}</strong></span>
                             <span class="file-size">Папка</span>
                             <span class="file-actions"></span>
                        {% else %}
                            <input type="checkbox" name="selected_files" value="{{ item.path }}" aria-label="Выбрать {{ item.name }}">

                        {% if item.preview %}
                            <img src="{{ item.preview }}" alt="Превью {{ item.name }}" class="file-preview" data-fullsize="{{ item.file }}">
                        {% else %}
                            <img src="{% static 'viewer/file.png' %}" alt="Файл" class="file-icon">
                        {% endif %}
                        
                            <span class="file-name">{{ item.name }}</span>
                            <span class="file-size">{{ item.size|filesizeformat }}</span> 
                            <span class="file-actions">
                                {% if item.url_path is not None %}
                                    {% url 'viewer:download_file' file_path=item.url_path as download_url %}
                                    <a href="{{ download_url }}" title="Скачать {{ item.name }}" class="btn btn-sm btn-secondary">Скачать</a>
                                {% endif %}
                            </span>
                        {% endif %}
                    </li>
                {% empty %}
                     <li class="no-files-message">Нет файлов или папок для отображения (с учетом фильтра).</li>
                {% endfor %}
            </ul>

            {% if items %}
               <div style="margin-top: var(--spacing-md); text-align: right;">
                   <button type="submit" class="btn">Скачать выбранное (.zip)</button>
               </div>
            {% endif %}
        </form>
        {% elif data.type == 'file' %}
             <ul class="file-list">
                 <li class="file-item">
                {% if data.preview %}
                    <img src="{{ data.preview }}" alt="Превью {{ data.name }}" class="file-preview" data-fullsize="{{ data.file }}">
                 {% else %}
                    <img src="{% static 'viewer/file.png' %}" alt="Файл" class="file-icon">
                 {% endif %}
                 <span class="file-name">{{ data.name }}</span>
                     <span class="file-size">{{ data.size|filesizeformat }}</span>
                     <span class="file-actions">
                        {% if data.url_path is not None %}
                        <a href="{% url 'viewer:download_file' file_path=item.url_path as download_url %}" title="Скачать {{ item.name }}" class="btn btn-sm btn-secondary">Скачать</a>
                        {% endif %}
                     </span>
                 </li>
             </ul>
        {% else %}
             {% if not error %}
             <p class="no-files-message">Не удалось получить содержимое по ссылке или папка пуста.</p>
             {% endif %}
        {% endif %}
    {% endif %}

{% endblock %}